<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>oak-chunk-update: openark kit documentation</title>
	<meta name="description" content="oak-chunk-update: openark kit" />
	<meta name="keywords" content="oak-chunk-update: openark kit" />
	<link rel="stylesheet" type="text/css" href="style.css" media="screen" />
</head>

<body>
	<div id="main">
		<div id="sidebarwrapper">
			<h3>openark kit documentation</h1>
			<div id="menu">
				<ul>
					<li class="page_item page-item-13"><a title="oak-apply-ri" href="oak-apply-ri.html">oak-apply-ri</a></li>
					<li class="page_item page-item-17"><a title="oak-block-account" href="oak-block-account.html">oak-block-account</a></li>
					<li class="page_item page-item-123 current_page_item"><a title="oak-chunk-update" href="oak-chunk-update.html">oak-chunk-update</a></li>
					<li class="page_item page-item-19"><a title="oak-kill-slow-queries" href="oak-kill-slow-queries.html">oak-kill-slow-queries</a></li>
					<li class="page_item page-item-21"><a title="oak-modify-charset" href="oak-modify-charset.html">oak-modify-charset</a></li>
					<li class="page_item page-item-99"><a title="oak-online-alter-table" href="oak-online-alter-table.html">oak-online-alter-table</a></li>
					<li class="page_item page-item-23"><a title="oak-purge-master-logs" href="oak-purge-master-logs.html">oak-purge-master-logs</a></li>
					<li class="page_item page-item-25"><a title="oak-security-audit" href="oak-security-audit.html">oak-security-audit</a></li>
					<li class="page_item page-item-31"><a title="oak-show-limits" href="oak-show-limits.html">oak-show-limits</a></li>
					<li class="page_item page-item-33"><a title="oak-show-replication-status" href="oak-show-replication-status.html">oak-show-replication-status</a></li>
				</ul>
			</div>
		</div>	
		<div id="content">
			<h1>oak-chunk-update</h1>	
<h3>NAME</h3>
oak-chunk-update: Perform long, non-blocking UPDATE/DELETE operation in auto managed small chunks
<h3>SYNOPSIS</h3>
Delete rows from world.City where population is small:
<blockquote>oak-chunk-update --database=world --execute="DELETE FROM City WHERE Population &lt; 10000000 AND OAK_CHUNK(City)"</blockquote>
Same as above, provide fully qualified table names:
<blockquote>oak-chunk-update --execute="DELETE FROM world.City WHERE Population &lt; 10000000 AND OAK_CHUNK(world.City)"</blockquote>
Same as above, use 1oo rows chunk size, verbose:
<blockquote>oak-chunk-update --database=world --execute="DELETE FROM City WHERE Population &lt; 10000000 AND OAK_CHUNK(City)" --chunk-size=100 --verbose</blockquote>
Same as above, print progress:
<blockquote>oak-chunk-update --database=world --execute="DELETE FROM City WHERE Population &lt; 10000000 AND OAK_CHUNK(City)" --chunk-size=100 --verbose --print-progress</blockquote>
Same as above, do not log to binary log:
<blockquote>oak-chunk-update --database=world --execute="DELETE FROM City WHERE Population &lt; 10000000 AND OAK_CHUNK(City)" --chunk-size=100 --verbose --print-progress --no-log-bin</blockquote>
Same as above, sleep for 10 milliseconds between chunks:
<blockquote>oak-chunk-update --database=world --execute="DELETE FROM City WHERE Population &lt; 10000000 AND OAK_CHUNK(City)" --chunk-size=100 --sleep=100 --verbose</blockquote>
Perform an UPDATE operation:
<blockquote>oak-chunk-update --database=world --execute="UPDATE City SET Population = Population+1 WHERE OAK_CHUNK(City)"</blockquote>
Perform a multi-table UPDATE operation, choose world.City as chunking table:
<blockquote>oak-chunk-update --execute="UPDATE City, Country SET City.District = 'unknown' WHERE City.CountryCode = Country.Code AND Country.Continent = 'Africa' AND OAK_CHUNK(City)"</blockquote>
Provide connection parameters. Prompt for password:
<blockquote>oak-chunk-update --user=root --ask-pass --socket=/tmp/mysql.sock  --database=world --execute="DELETE FROM City WHERE Population &lt; 10000000 AND OAK_CHUNK(City)"</blockquote>
Use a defaults file for parameters.
<blockquote>oak-chunk-update --defaults-file=/home/myuser/.my-oak.cnf  --database=world --execute="DELETE FROM City WHERE Population &lt; 10000000 AND OAK_CHUNK(City)"</blockquote>
<h3>DESCRIPTION</h3>
This utility allows for splitting long running or non-indexed UPDATE/DELETE oprations, optionally multi-table ones.
Long running updating queries are often used. Some examples:
<ul>
	<li>Purging old table records (e.g. purging old logs).</li>
	<li>Updating a column on a table scale.</li>
	<li>Deleting or updating a small number of rows, but with a non-indexed search condition.</li>
</ul>
oak-chunk-update splits such long running tasks into small chunks. It also allows for sleep time between chunks. This allows for less lock time, better replication responsiveness (less lag) and less stress on system resources (CPU, IO).
To perform, the utility uses a UNIQUE KEY on a given table, which is used for the splitting process.
Note that the query may involve multiple tables (JOINed), in which case one of the tables must have a UNIQUE KEY.
The utility requires, then:
<ul>
	<li>At least on of the tables participating in the UPDATE/DELETE query has a UNIQUE KEY.</li>
	<li>The query must indicate to the utility the table for which the UNIQUE KEY is used.</li>
</ul>
The query must include a hint in the form <strong>OAK_CHUNK(table_name)</strong> or <strong>OAK_CHUNK(database_name.table_name)</strong>. See SYNOPSIS for examples.
The table indicated in the <strong>OAK_CHUNK</strong> clause is the table which must contain a UNIQUE KEY, which is used for splitting the query. The utility rewrites the query by iteratively replacing the <strong>OAK_CHUNK(...)</strong> clause with appropriate values from the UNIQUE KEY.
In case more than one UNIQUE KEY is available on the table, the utility chooses in the following order:
<ul>
	<li>If there's a PRIMARY KEY - this is the selected key</li>
	<li>A key for which the first column is non-textual is prefereable to a key for which the first column is textual</li>
	<li>A key with a smaller numeric data type takes precedance</li>
	<li>A key with fewer columns take precedance</li>
</ul>
<h3>OPTIONS</h3>
--ask-pass
<p class="indent">Prompt for password.</p>

-c CHUNK_SIZE, --chunk-size=CHUNK_SIZE
<p class="indent">Number of rows to act on in chunks (default: 1000). 0 means all rows updated in one operation
The lower the number, the shorter any locks are held, but the more operations required and the more total running time.

-d DATABASE, --database=DATABASE
<p class="indent">Database name (required unless table is fully qualified)</p>

--defaults-file=DEFAULTS_FILE
<p class="indent">Read from MySQL configuration file. Overrides --user, --password, --socket, --port.</p>
<p class="indent">Configuration needs to be in the following format:</p>

<p class="indent"><strong>[client]
user=my_user
password=my_pass
socket=/tmp/mysql.sock
port=3306</strong>

-e EXECUTE_QUERY, --execute=EXECUTE_QUERY
<p class="indent">Query (UPDATE or DELETE) to execute, which contains a chunk placeholder (required)</p>

-H HOST, --host=HOST
<p class="indent">MySQL host (default: localhost)</p>

--no-log-bin
<p class="indent">Do not log to binary log (actions will not replicate). This may be useful if the slave already finds it hard to replicate behind master. The utility may be spawned manually on slave machines, therefore utilizing more than one CPU core on those machines, making replication process faster due to parallelism.</p>

-p PASSWORD, --password=PASSWORD
<p class="indent">MySQL password</p>

-P PORT, --port=PORT
<p class="indent">TCP/IP port (default: 3306)</p>

--print-progress
<p class="indent">Show number of affected rows during utility runtime</p>

--sleep=SLEEP_MILLIS
<p class="indent">Number of milliseconds to sleep between chunks. Default: 0</p>

-S SOCKET, --socket=SOCKET
<p class="indent">MySQL socket file. Only applies when host is localhost</p>

-u USER, --user=USER
<p class="indent">MySQL user</p>

-v, --verbose
<p class="indent">Print user friendly messages</p>

<h3>ENVIRONMENT</h3>
Requires MySQL 5.0 or newer, python 2.3 or newer.

python-mysqldb must be installed in order to use this tool. You can
<blockquote>apt-get install python-mysqldb</blockquote>
or
<blockquote>yum install mysql-python</blockquote>
<h3>SEE ALSO</h3>
<h3>LICENSE</h3>
This tool is released under the BSD license.
<blockquote><pre>Copyright (c) 2008 - 2010, Shlomi Noach
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
* Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
* Neither the name of the organization nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR 
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT 
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR 
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</pre>
</blockquote>
<h3>AUTHOR</h3>
Shlomi Noach
			<br/>
			<br/>
		</div>
		<div class="clear">&nbsp;</div>
		<div id="footnote" align="center">
			<a href="">openark kit</a> documentation
		</div>
	</div>
</body>
</html>
